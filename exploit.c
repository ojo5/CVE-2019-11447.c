#include <stdio.h>
#include <stdlib.h>
#include <string.h>
/*
A C implementation of CVE-2019-11447
Found By : Akkus  [ https://twitter.com/ehakkus     ]
PoC By   : Weaver [ https://twitter.com/VCWeaver ]
*/

// Function prototypes
void print_usage(const char *prog_name);

// Function to print usage information
void print_usage(const char *prog_name) {
    printf("Usage: %s -t TARGET -u USERNAME -p PASSWORD -lh LISTENER_IP -lp LISTENER_PORT -f FILENAME\n", prog_name);
    printf("  -t, --target   Target IP address or domain\n");
    printf("  -u, --uname    Username\n");
    printf("  -p, --passw    Password\n");
    printf("  -lh, --lhost   Listener IP address\n");
    printf("  -lp, --lport   Listener Port (default: 4444)\n");
    printf("  -f, --file     Filename for payload WITHOUT extension (default: payload)\n");
}

int main(int argc, char *argv[]) {
    // Variables to store arguments
    char *target = NULL;
    char *uname = NULL;
    char *passw = NULL;
    char *lhost = NULL;
    int lport = 4444; // Default port
    char *file = "payload"; // Default filename

    // Check if at least the required arguments are provided
    if (argc < 7) {
        print_usage(argv[0]);
        return 1;
    }

    // Parse command-line arguments
    for (int i = 1; i < argc; i++) {
        if (strcmp(argv[i], "-t") == 0 || strcmp(argv[i], "--target") == 0) {
            if (i + 1 < argc) {
                target = argv[++i];
            } else {
                fprintf(stderr, "Error: Missing value for -t/--target\n");
                return 1;
            }
        } else if (strcmp(argv[i], "-u") == 0 || strcmp(argv[i], "--uname") == 0) {
            if (i + 1 < argc) {
                uname = argv[++i];
            } else {
                fprintf(stderr, "Error: Missing value for -u/--uname\n");
                return 1;
            }
        } else if (strcmp(argv[i], "-p") == 0 || strcmp(argv[i], "--passw") == 0) {
            if (i + 1 < argc) {
                passw = argv[++i];
            } else {
                fprintf(stderr, "Error: Missing value for -p/--passw\n");
                return 1;
            }
        } else if (strcmp(argv[i], "-lh") == 0 || strcmp(argv[i], "--lhost") == 0) {
            if (i + 1 < argc) {
                lhost = argv[++i];
            } else {
                fprintf(stderr, "Error: Missing value for -lh/--lhost\n");
                return 1;
            }
        } else if (strcmp(argv[i], "-lp") == 0 || strcmp(argv[i], "--lport") == 0) {
            if (i + 1 < argc) {
                lport = atoi(argv[++i]);
                if (lport <= 0 || lport > 65535) {
                    fprintf(stderr, "Error: Invalid port number\n");
                    return 1;
                }
            } else {
                fprintf(stderr, "Error: Missing value for -lp/--lport\n");
                return 1;
            }
        } else if (strcmp(argv[i], "-f") == 0 || strcmp(argv[i], "--file") == 0) {
            if (i + 1 < argc) {
                file = argv[++i];
            } else {
                fprintf(stderr, "Error: Missing value for -f/--file\n");
                return 1;
            }
        } else {
            fprintf(stderr, "Error: Unknown argument %s\n", argv[i]);
            print_usage(argv[0]);
            return 1;
        }
    }

    // Print the parsed arguments
    printf("Target: %s\n", target);
    printf("Username: %s\n", uname);
    printf("Password: %s\n", passw);
    printf("Listener IP: %s\n", lhost);
    printf("Listener Port: %d\n", lport);
    printf("Filename: %s\n", file);

    return 0;


    // Your code here...

    return 0;
}